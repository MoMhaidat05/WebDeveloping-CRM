{% extends "layout.html" %} {% block content %}
<div
  id="toast-container"
  class="fixed top-5 right-5 z-50 flex flex-col gap-2"
></div>
<div class="space-y-6">
  <div
    class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4"
  >
    <div>
      <h1 class="text-2xl font-bold text-text-primary">Customers</h1>
      <p class="text-text-secondary text-sm mt-1">
        Manage and track all system clients
      </p>
    </div>

    <div class="flex items-center gap-3 w-full md:w-auto">
      <div class="relative group w-full md:w-64">
        <i
          class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-text-secondary group-focus-within:text-accent transition-colors"
        ></i>
        <input
          type="text"
          placeholder="Search clients..."
          class="w-full bg-surface border border-border text-text-primary text-sm rounded-lg pl-10 pr-4 py-2.5 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent transition-all"
        />
      </div>

      <button
        onclick="openAddModal()"
        class="bg-accent hover:cursor-pointer hover:bg-emerald-600 text-bg font-medium px-4 py-2.5 rounded-lg flex items-center gap-2 transition-all shadow-lg shadow-accent/20 whitespace-nowrap"
      >
        <i class="fa-solid fa-plus"></i>
        <span>New Customer</span>
      </button>
    </div>
  </div>

  <div
    class="bg-surface rounded-xl border border-border shadow-xl overflow-hidden"
  >
    {% if clients %}
    <div class="overflow-x-auto">
      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="bg-bg/50 border-b border-border">
            <th
              class="p-4 text-xs font-semibold tracking-wide text-text-secondary uppercase"
            >
              Client Details
            </th>
            <th
              class="p-4 text-xs font-semibold tracking-wide text-text-secondary uppercase"
            >
              Business Info
            </th>
            <th
              class="p-4 text-xs font-semibold tracking-wide text-text-secondary uppercase"
            >
              Contact Numbers
            </th>
            <th
              class="p-4 text-xs font-semibold tracking-wide text-text-secondary uppercase"
            >
              Email
            </th>
            <th
              class="p-4 text-xs font-semibold tracking-wide text-text-secondary uppercase text-center"
            >
              Location
            </th>
            <th
              class="p-4 text-xs font-semibold tracking-wide text-text-secondary uppercase"
            >
              Status
            </th>
            <th
              class="p-4 text-xs font-semibold tracking-wide text-text-secondary uppercase text-right"
            >
              Actions
            </th>
          </tr>
        </thead>

        <tbody class="divide-y divide-border">
          {% for client in clients %}
          <tr
            class="group hover:bg-white/5 transition-colors duration-200"
            id="client-{{client.id}}"
          >
            <td class="p-4 align-top">
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 rounded-full bg-accent/10 text-accent flex items-center justify-center font-bold border border-accent/20 flex-shrink-0"
                >
                  {{ client.full_name[0] | upper }}
                </div>
                <div>
                  <h3
                    class="font-bold text-text-primary group-hover:text-accent transition-colors"
                  >
                    {{ client.full_name }}
                  </h3>
                  {% if client.nickname %}
                  <span class="text-xs text-text-secondary block"
                    >({{ client.nickname }})</span
                  >
                  {% endif %}
                </div>
              </div>
            </td>

            <td class="p-4 align-top">
              <div class="font-medium text-text-primary">
                {{ client.business_name or '-' }}
              </div>
              <div class="text-xs text-text-secondary flex items-center mt-1">
                <i class="fa-solid fa-city ml-1 text-[10px]"></i> {{ client.city
                }}
              </div>
            </td>

            <td class="p-4 align-top">
              <div class="text-sm text-text-primary font-mono">
                {{ client.phone_primary }}
              </div>
              {% if client.phone_secondary %}
              <div
                class="text-xs text-text-secondary mt-1 flex items-center gap-1"
              >
                <i class="fa-solid fa-phone text-[10px]"></i> {{
                client.phone_secondary }}
              </div>
              {% endif %}
            </td>

            <td class="p-4 align-top text-sm">
              {% if client.email %}
              <span class="text-text-primary">{{ client.email }}</span>
              {% else %}
              <span class="text-text-secondary">-</span>
              {% endif %}
            </td>

            <td class="p-4 align-middle text-center">
              {% if client.location_url %}
              <a
                href="{{ client.location_url }}"
                target="_blank"
                class="w-8 h-8 rounded-full bg-accent/10 text-accent flex items-center justify-center hover:bg-accent hover:text-white transition-all mx-auto"
                title="Open Location"
              >
                <i class="fa-solid fa-location-dot"></i>
              </a>
              {% else %}
              <span class="text-text-secondary text-xs">-</span>
              {% endif %}
            </td>

            <td class="p-4 align-middle">
              {% if client.status == 'Active' %}
              <span
                class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-success/10 text-success border border-success/20"
              >
                <span
                  class="w-1.5 h-1.5 rounded-full bg-success animate-pulse"
                ></span>
                Active
              </span>
              {% else %}
              <span
                class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-text-secondary/10 text-text-secondary border border-border"
              >
                Inactive
              </span>
              {% endif %}
            </td>

            <td class="p-4 align-middle text-right">
              <div
                class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity"
              >
                <button
                  onclick="openEditModal('{{ client.id }}', '{{ client.full_name }}', '{{ client.phone_primary }}', '{{ client.business_name or '' }}', '{{ client.status }}')"
                  class="w-8 h-8 rounded-lg flex items-center justify-center bg-blue-500/10 text-blue-400 hover:bg-blue-500 hover:text-white transition-all"
                  title="Edit"
                >
                  <i class="fa-solid fa-pen text-xs"></i>
                </button>

                <button
                  onclick="openDeleteModal('{{ client.id }}')"
                  class="w-8 h-8 rounded-lg flex items-center justify-center bg-danger/10 text-danger hover:bg-danger hover:text-white transition-all"
                  title="Delete"
                >
                  <i class="fa-solid fa-trash text-xs"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div
      class="p-4 border-t border-border flex items-center justify-between text-xs text-text-secondary"
    >
      <span id="clients-length">Showing {{ clients|length }} clients</span>
      <div class="flex gap-1">
        <button
          class="px-2 py-1 rounded hover:bg-bg disabled:opacity-50"
          disabled
        >
          Previous
        </button>
        <button class="px-2 py-1 rounded hover:bg-bg">Next</button>
      </div>
    </div>

    {% else %}
    <div class="flex flex-col items-center justify-center py-16 text-center">
      <div
        class="w-20 h-20 bg-bg rounded-full flex items-center justify-center mb-4 shadow-inner"
      >
        <i class="fa-solid fa-users-slash text-3xl text-text-secondary/50"></i>
      </div>
      <h3 class="text-lg font-medium text-text-primary mb-1">
        No clients found
      </h3>
      <p class="text-text-secondary text-sm max-w-xs mb-6">
        You haven't added any clients to the system yet. Start by adding your
        first client.
      </p>
      <button
        onclick="openAddModal()"
        class="bg-surface border border-border hover:border-accent text-accent px-6 py-2 rounded-lg text-sm font-medium hover:cursor-pointer transition-colors"
      >
        <i class="fa-solid fa-plus mr-2"></i> Add New Customer
      </button>
    </div>
    {% endif %}
  </div>
</div>

<div
  id="addModal"
  class="fixed inset-0 z-50 hidden"
  aria-labelledby="modal-title"
  role="dialog"
  aria-modal="true"
>
  <div
    class="fixed inset-0 bg-black/60 transition-opacity backdrop-blur-sm"
    onclick="closeAddModal()"
  ></div>
  <div class="fixed inset-0 z-10 overflow-y-auto">
    <div
      class="flex min-h-full items-center justify-center p-4 text-center sm:p-0"
    >
      <div
        class="relative transform overflow-hidden rounded-xl bg-surface border border-border text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg"
      >
        <div
          class="px-6 py-4 border-b border-border flex justify-between items-center bg-bg/30"
        >
          <h3 class="text-lg font-bold text-text-primary">Add New Customer</h3>
          <button
            onclick="closeAddModal()"
            class="text-text-secondary hover:text-text-primary transition-colors"
          >
            <i class="fa-solid fa-xmark text-xl"></i>
          </button>
        </div>

        <form id="addClientForm" onsubmit="handleAddSubmit(event)">
          <div class="px-6 py-6 space-y-4">
            <div>
              <label class="block text-sm font-medium text-text-secondary mb-1"
                >Full Name</label
              >
              <input
                type="text"
                name="full_name"
                required
                class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent placeholder-text-secondary/50"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-text-secondary mb-1"
                >Nickname</label
              >
              <input
                type="text"
                name="nickname"
                class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent placeholder-text-secondary/50"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-text-secondary mb-1"
                >Phone Number</label
              >
              <input
                type="text"
                name="phone_primary"
                required
                class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent placeholder-text-secondary/50"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-text-secondary mb-1"
                >Secondary Phone Number</label
              >
              <input
                type="text"
                name="phone_secondary"
                class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent placeholder-text-secondary/50"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-text-secondary mb-1"
                >Email</label
              >
              <input
                type="email"
                name="email"
                class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent placeholder-text-secondary/50"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-text-secondary mb-1"
                >Business Name</label
              >
              <input
                type="text"
                name="business_name"
                required
                class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent placeholder-text-secondary/50"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-text-secondary mb-1"
                >City</label
              >
              <input
                type="text"
                name="city"
                required
                class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent placeholder-text-secondary/50"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-text-secondary mb-1"
                >Location URL</label
              >
              <input
                type="text"
                name="location_url"
                class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent placeholder-text-secondary/50"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-text-secondary mb-1"
                >Status</label
              >
              <select
                name="status"
                required
                class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent"
              >
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
            </div>
          </div>

          <div
            class="px-6 py-4 bg-bg/30 border-t border-border flex flex-row-reverse gap-3"
          >
            <button
              type="submit"
              class="w-full hover:cursor-pointer sm:w-auto inline-flex justify-center rounded-lg bg-accent px-4 py-2 text-sm font-bold text-bg shadow-sm hover:bg-emerald-600 sm:ml-3"
            >
              Save
            </button>
            <button
              type="button"
              onclick="closeAddModal()"
              class="mt-3 hover:cursor-pointer sm:mt-0 w-full sm:w-auto inline-flex justify-center rounded-lg bg-transparent border border-border px-4 py-2 text-sm font-medium text-text-secondary hover:bg-bg hover:text-text-primary"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div id="editModal" class="fixed inset-0 z-50 hidden">
  <div
    class="fixed inset-0 bg-black/60 transition-opacity backdrop-blur-sm"
    onclick="closeEditModal()"
  ></div>
  <div class="fixed inset-0 z-10 overflow-y-auto">
    <div
      class="flex min-h-full items-center justify-center p-4 text-center sm:p-0"
    >
      <div
        class="relative transform overflow-hidden rounded-xl bg-surface border border-border text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg"
      >
        <div
          class="px-6 py-4 border-b border-border flex justify-between items-center bg-bg/30"
        >
          <h3 class="text-lg font-bold text-text-primary">Edit Customer</h3>
          <button
            onclick="closeEditModal()"
            class="text-text-secondary hover:text-text-primary"
          >
            <i class="fa-solid fa-xmark text-xl"></i>
          </button>
        </div>

        <form id="editClientForm" onsubmit="handleEditSubmit(event)">
          <input type="hidden" id="edit_client_id" name="client_id" />

          <div class="px-6 py-6 space-y-4">
            <div>
              <label class="block text-sm font-medium text-text-secondary mb-1"
                >Full Name</label
              >
              <input
                type="text"
                id="edit_full_name"
                name="full_name"
                required
                class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-text-secondary mb-1"
                >Nickname</label
              >
              <input
                type="text"
                id="edit_nickname"
                name="nickname"
                class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent placeholder-text-secondary/50"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-text-secondary mb-1"
                >Phone Number</label
              >
              <input
                type="text"
                id="edit_phone"
                name="phone_primary"
                required
                class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-text-secondary mb-1"
                >Secondary Phone Number</label
              >
              <input
                type="text"
                id="edit_phone_secondary"
                name="phone_secondary"
                class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent placeholder-text-secondary/50"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-text-secondary mb-1"
                >Email</label
              >
              <input
                type="email"
                id="edit_email"
                name="email"
                class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent placeholder-text-secondary/50"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-text-secondary mb-1"
                >Business Name</label
              >
              <input
                type="text"
                id="edit_business"
                name="business_name"
                class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-text-secondary mb-1"
                >City</label
              >
              <input
                type="text"
                id="edit_city"
                name="city"
                class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent placeholder-text-secondary/50"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-text-secondary mb-1"
                >Location URL</label
              >
              <input
                type="text"
                id="edit_location_url"
                name="location_url"
                class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent placeholder-text-secondary/50"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-text-secondary mb-1"
                >Status</label
              >
              <select
                id="edit_status"
                name="status"
                class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent"
              >
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
            </div>
          </div>

          <div
            class="px-6 py-4 bg-bg/30 border-t border-border flex flex-row-reverse gap-3"
          >
            <button
              type="submit"
              class="w-full sm:w-auto inline-flex justify-center rounded-lg bg-accent px-4 py-2 text-sm font-bold text-bg hover:bg-emerald-600 sm:ml-3"
            >
              Update
            </button>
            <button
              type="button"
              onclick="closeEditModal()"
              class="mt-3 sm:mt-0 w-full sm:w-auto inline-flex justify-center rounded-lg bg-transparent border border-border px-4 py-2 text-sm font-medium text-text-secondary hover:bg-bg hover:text-text-primary"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div id="deleteModal" class="fixed inset-0 z-50 hidden">
  <div
    class="fixed inset-0 bg-black/60 transition-opacity backdrop-blur-sm"
    onclick="closeDeleteModal()"
  ></div>
  <div class="fixed inset-0 z-10 overflow-y-auto">
    <div
      class="flex min-h-full items-center justify-center p-4 text-center sm:p-0"
    >
      <div
        class="relative transform overflow-hidden rounded-xl bg-surface border border-border text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-md"
      >
        <div class="px-6 py-6 text-center">
          <div
            class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-danger/10 mb-4"
          >
            <i class="fa-solid fa-triangle-exclamation text-danger text-xl"></i>
          </div>
          <h3 class="text-lg font-bold text-text-primary mb-2">
            Delete Customer?
          </h3>
          <p class="text-sm text-text-secondary">
            Are you sure you want to delete this customer? This action cannot be
            undone and will remove all associated services.
          </p>
        </div>

        <div
          class="px-6 py-4 bg-bg/30 border-t border-border flex flex-row-reverse gap-3"
        >
          <form
            id="deleteClientForm"
            onsubmit="handleDeleteSubmit(event)"
            class="w-full sm:w-auto"
          >
            <input type="hidden" id="delete_client_id" name="client_id" />
            <button
              type="submit"
              class="w-full inline-flex justify-center rounded-lg bg-danger px-4 py-2 text-sm font-bold text-white hover:bg-red-600 sm:ml-3"
            >
              Delete
            </button>
          </form>
          <button
            type="button"
            onclick="closeDeleteModal()"
            class="mt-3 sm:mt-0 w-full sm:w-auto inline-flex justify-center rounded-lg bg-transparent border border-border px-4 py-2 text-sm font-medium text-text-secondary hover:bg-bg hover:text-text-primary"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // --- Modal & Toast Functions (كما هي) ---
  function openAddModal() {
    document.getElementById("addModal").classList.remove("hidden");
  }

  function closeAddModal() {
    document.getElementById("addModal").classList.add("hidden");
  }

  function openEditModal(
    id,
    fullName,
    phone,
    business,
    status,
    nickname,
    phoneSecondary,
    email,
    city,
    locationUrl
  ) {
    document.getElementById("edit_client_id").value = id;
    document.getElementById("edit_full_name").value = fullName;
    document.getElementById("edit_phone").value = phone;
    document.getElementById("edit_business").value = business;
    document.getElementById("edit_status").value = status;
    // تعبئة الحقول الجديدة (مع مراعاة القيم الفارغة)
    document.getElementById("edit_nickname").value = nickname || "";
    document.getElementById("edit_phone_secondary").value =
      phoneSecondary || "";
    document.getElementById("edit_email").value = email || "";
    document.getElementById("edit_city").value = city || "";
    document.getElementById("edit_location_url").value = locationUrl || "";

    document.getElementById("editModal").classList.remove("hidden");
  }

  function closeEditModal() {
    document.getElementById("editModal").classList.add("hidden");
  }

  function openDeleteModal(id) {
    document.getElementById("delete_client_id").value = id;
    document.getElementById("deleteModal").classList.remove("hidden");
  }

  function closeDeleteModal() {
    document.getElementById("deleteModal").classList.add("hidden");
  }

  function showToast(message, type = "success") {
    const container = document.getElementById("toast-container");
    const toast = document.createElement("div");

    let bgClass =
      type === "success"
        ? "toast-success"
        : type === "error"
        ? "toast-error"
        : "toast-warning";

    let icon =
      type === "success"
        ? "<i class='fa-solid fa-check-circle'></i>"
        : "<i class='fa-solid fa-triangle-exclamation'></i>";

    toast.className = `toast ${bgClass}`;
    toast.innerHTML = `${icon} <span>${message}</span>`;

    container.appendChild(toast);

    requestAnimationFrame(() => {
      toast.classList.add("show");
    });

    setTimeout(() => {
      toast.classList.remove("show");
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // --- Core Logic: HTML Generator ---

  // هذه هي الدالة المفقودة! وظيفتها توليد HTML للسطر بناءً على بيانات العميل
  function getRowInnerHtml(client) {
    // 1. معالجة البيانات النصية
    const initial = client.full_name
      ? client.full_name.charAt(0).toUpperCase()
      : "?";
    const nicknameHtml = client.nickname
      ? `<span class="text-xs text-text-secondary block">(${client.nickname})</span>`
      : "";
    const secondaryPhoneHtml = client.phone_secondary
      ? `<div class="text-xs text-text-secondary mt-1 flex items-center gap-1"><i class="fa-solid fa-phone text-[10px]"></i> ${client.phone_secondary}</div>`
      : "";
    const emailHtml = client.email
      ? `<span class="text-text-primary">${client.email}</span>`
      : `<span class="text-text-secondary">-</span>`;

    // 2. منطق أيقونة الموقع (يظهر فقط إذا وجد الرابط)
    let locationHtml = '<span class="text-text-secondary text-xs">-</span>';
    if (client.location_url && client.location_url.trim() !== "") {
      locationHtml = `
            <a href="${client.location_url}" target="_blank" class="w-8 h-8 rounded-full bg-accent/10 text-accent flex items-center justify-center hover:bg-accent hover:text-white transition-all mx-auto" title="Open Location">
                <i class="fa-solid fa-location-dot"></i>
            </a>`;
    }

    // 3. حالة العميل
    const statusHtml =
      client.status === "Active"
        ? `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-success/10 text-success border border-success/20"><span class="w-1.5 h-1.5 rounded-full bg-success animate-pulse"></span>Active</span>`
        : `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-text-secondary/10 text-text-secondary border border-border">Inactive</span>`;

    // 4. إرجاع HTML الخلايا
    // ملاحظة هامة: في زر التعديل (Edit Button) نقوم بتمرير القيم الجديدة لضمان تحديث المودال في المرة القادمة
    return `
        <td class="p-4 align-top">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-accent/10 text-accent flex items-center justify-center font-bold border border-accent/20 flex-shrink-0">
                    ${initial}
                </div>
                <div>
                    <h3 class="font-bold text-text-primary group-hover:text-accent transition-colors">
                        ${client.full_name}
                    </h3>
                    ${nicknameHtml}
                </div>
            </div>
        </td>

        <td class="p-4 align-top">
            <div class="font-medium text-text-primary">${
              client.business_name || "-"
            }</div>
            <div class="text-xs text-text-secondary flex items-center mt-1">
                <i class="fa-solid fa-city ml-1 text-[10px]"></i> ${
                  client.city || "-"
                }
            </div>
        </td>

        <td class="p-4 align-top">
            <div class="text-sm text-text-primary font-mono">${
              client.phone_primary
            }</div>
            ${secondaryPhoneHtml}
        </td>

        <td class="p-4 align-top text-sm">
            ${emailHtml}
        </td>

        <td class="p-4 align-middle text-center">
            ${locationHtml}
        </td>

        <td class="p-4 align-middle">
            ${statusHtml}
        </td>

        <td class="p-4 align-middle text-right">
            <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <button onclick="openEditModal('${client.id}', '${
      client.full_name
    }', '${client.phone_primary}', '${client.business_name || ""}', '${
      client.status
    }', '${client.nickname || ""}', '${client.phone_secondary || ""}', '${
      client.email || ""
    }', '${client.city || ""}', '${client.location_url || ""}')" 
                        class="w-8 h-8 rounded-lg flex items-center justify-center bg-blue-500/10 text-blue-400 hover:bg-blue-500 hover:text-white transition-all" title="Edit">
                    <i class="fa-solid fa-pen text-xs"></i>
                </button>
                <button onclick="openDeleteModal('${client.id}')" 
                        class="w-8 h-8 rounded-lg flex items-center justify-center bg-danger/10 text-danger hover:bg-danger hover:text-white transition-all" title="Delete">
                    <i class="fa-solid fa-trash text-xs"></i>
                </button>
            </div>
        </td>
    `;
  }

  // --- Handlers ---

  function addRowToTable(client) {
    const tbody = document.querySelector("table tbody");
    const tr = document.createElement("tr");
    // إضافة ID للسطر لكي نتمكن من العثور عليه لاحقاً عند التعديل أو الحذف
    tr.id = `client-${client.id}`;
    tr.className = "group hover:bg-white/5 transition-colors duration-200";

    // استخدام الدالة الموحدة لتوليد المحتوى
    tr.innerHTML = getRowInnerHtml(client);

    tbody.prepend(tr);
  }

  async function handleAddSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
      const response = await fetch("/api/clients", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      const responseJSON = await response.json();

      if (response.ok) {
        closeAddModal();
        form.reset();
        showToast("Client added successfully!", "success");
        const clientsLengthSpan =
          document.getElementById("clients-length");
        clientsLengthSpan.textContent = `Showing ${
          parseInt(clientsLengthSpan.textContent.match(/\d+/)[0]) + 1
        } clients`;

        if (responseJSON.client) {
          addRowToTable(responseJSON.client);
        } else {
          window.location.reload();
        }
      } else {
        showToast(responseJSON.error || "Error adding client", "error");
      }
    } catch (error) {
      console.error("Network Error:", error);
      showToast("Failed to connect to server", "error");
    }
  }

  async function handleEditSubmit(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData.entries());


    try {
      const response = await fetch(`/api/clients`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      const responseData = await response.json();

      if (response.ok) {
        showToast("Client updated successfully!", "success");

        // 1. العثور على السطر في الجدول باستخدام الـ ID
        // ملاحظة: تأكد أن الأسطر القادمة من السيرفر (Jinja2) لها أيضاً
        const row = document.getElementById(`client-${data.client_id}`);

        if (row) {
          // 2. بناء كائن العميل المحدث من بيانات الفورم
          const updatedClient = {
            id: data.client_id,
            full_name: data.full_name,
            nickname: data.nickname,
            phone_primary: data.phone_primary,
            phone_secondary: data.phone_secondary,
            email: data.email,
            business_name: data.business_name,
            city: data.city,
            location_url: data.location_url, // إذا تم وضع رابط هنا، الدالة getRowInnerHtml ستظهر الأيقونة
            status: data.status,
          };

          // 3. تحديث محتوى السطر بالكامل باستخدام الدالة الموحدة
          row.innerHTML = getRowInnerHtml(updatedClient);

          // تأثير وميض
          row.classList.add("bg-accent/10");
          setTimeout(() => row.classList.remove("bg-accent/10"), 1000);
        } else {
          // إذا لم يتم العثور على السطر (نادر الحدوث)، نقوم بالتحديث الكامل
          window.location.reload();
        }
      } else {
        showToast(responseData.error || "Error updating client", "error");
      }
    } catch (error) {
      console.error("Network Error:", error);
      showToast("Failed to connect to server", "error");
    }

    closeEditModal();
  }

  async function handleDeleteSubmit(event) {
    event.preventDefault();
    const id = document.getElementById("delete_client_id").value;
    
    try {
      const response = await fetch(`/api/clients?id=${id}`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
      });
      const data = await response.json();

      closeDeleteModal();

      if (response.ok) {
        showToast("Client deleted successfully!", "success");
        const clientsLengthSpan =
          document.getElementById("clients-length");
        if (clientsLengthSpan) {
          clientsLengthSpan.textContent = `Showing ${
            parseInt(clientsLengthSpan.textContent.match(/\d+/)[0]) - 1
          } clients`; 
        }
        const row = document.getElementById(`client-${id}`);
        if (row) {
          row.remove();
        } else {
          window.location.reload();
        }
      } else {
        showToast(data.error || "Error deleting client", "error");
      }
    } catch (error) {
      console.error("Network Error:", error);
      showToast("Failed to connect to server", "error");
    }
  }
</script>
{% endblock %}
