{% extends "layout.html" %} {% block content %}
<div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>

<div class="space-y-6">
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
    <div>
      <h1 class="text-2xl font-bold text-text-primary">Financials</h1>
      <p class="text-text-secondary text-sm mt-1">
        Track project payments, debts, and renewals
      </p>
    </div>

    <div class="flex items-center gap-3 w-full md:w-auto">
      <div class="relative group w-full md:w-64">
        <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-text-secondary group-focus-within:text-accent transition-colors"></i>
        <input
          type="text"
          placeholder="Search projects..."
          class="w-full bg-surface border border-border text-text-primary text-sm rounded-lg pl-10 pr-4 py-2.5 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent transition-all"
        />
      </div>

      <button
        onclick="openAddModal()"
        class="bg-accent hover:cursor-pointer hover:bg-emerald-600 text-bg font-medium px-4 py-2.5 rounded-lg flex items-center gap-2 transition-all shadow-lg shadow-accent/20 whitespace-nowrap"
      >
        <i class="fa-solid fa-plus"></i>
        <span>New Record</span>
      </button>
    </div>
  </div>

  <div class="bg-surface rounded-xl border border-border shadow-xl overflow-hidden">
    {% if financials %}
    <div class="overflow-x-auto">
      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="bg-bg/50 border-b border-border">
            <th class="p-4 text-xs font-semibold tracking-wide text-text-secondary uppercase">Project & Client</th>
            <th class="p-4 text-xs font-semibold tracking-wide text-text-secondary uppercase">Payment Status</th>
            <th class="p-4 text-xs font-semibold tracking-wide text-text-secondary uppercase">Remaining</th>
            <th class="p-4 text-xs font-semibold tracking-wide text-text-secondary uppercase">Renewal Info</th>
            <th class="p-4 text-xs font-semibold tracking-wide text-text-secondary uppercase text-center">Last Payment</th>
            <th class="p-4 text-xs font-semibold tracking-wide text-text-secondary uppercase text-right">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-border">
          {% for item in financials %}
          <tr id="financial-row-{{ item.id }}" class="group hover:bg-white/5 transition-colors duration-200">
            
            <td class="p-4 align-top">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-accent/10 text-accent flex items-center justify-center font-bold border border-accent/20 flex-shrink-0">
                        <i class="fa-solid fa-file-invoice-dollar"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-text-primary group-hover:text-accent transition-colors">
                            {{ item.project_title }}
                        </h3>
                        <span class="text-xs text-text-secondary block flex items-center gap-1">
                            <i class="fa-solid fa-user text-[10px]"></i> {{ item.client.full_name }}
                        </span>
                    </div>
                </div>
            </td>

            <td class="p-4 align-top">
                <div class="flex flex-col gap-1 w-32">
                    <div class="flex justify-between text-xs text-text-primary mb-1">
                        <span>Paid: {{ item.paid_amount }}</span>
                        <span class="text-text-secondary">/ {{ item.total_amount }}</span>
                    </div>
                    <div class="w-full bg-bg rounded-full h-1.5 border border-border overflow-hidden">
                        {% set percent = (item.paid_amount / item.total_amount * 100) if item.total_amount > 0 else 0 %}
                        <div class="bg-accent h-1.5 rounded-full" style="width: {{ percent }}%"></div>
                    </div>
                </div>
            </td>

            <td class="p-4 align-top">
                {% if item.remaining_amount <= 0 %}
                <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md text-xs font-medium bg-success/10 text-success border border-success/20">
                    <i class="fa-solid fa-check"></i> Paid
                </span>
                {% else %}
                <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md text-xs font-medium bg-danger/10 text-danger border border-danger/20 font-mono">
                    {{ item.remaining_amount }}
                </span>
                {% endif %}
            </td>

            <td class="p-4 align-top">
                <div class="flex flex-col gap-1">
                    {% if item.renewal_price > 0 %}
                    <span class="text-sm text-text-primary font-mono">{{ item.renewal_price }} JOD</span>
                    {% if item.next_renewal_date %}
                    <div class="text-xs text-text-secondary flex items-center gap-1">
                        <i class="fa-regular fa-calendar"></i> {{ item.next_renewal_date }}
                    </div>
                    {% endif %}
                    {% else %}
                    <span class="text-text-secondary text-xs">-</span>
                    {% endif %}
                </div>
            </td>

            <td class="p-4 align-middle text-center">
                {% if item.last_payment_date %}
                <span class="text-xs text-text-secondary border border-border px-2 py-1 rounded bg-bg">
                    {{ item.last_payment_date }}
                </span>
                {% else %}
                <span class="text-text-secondary text-xs">-</span>
                {% endif %}
            </td>

            <td class="p-4 align-middle text-right">
                <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button 
                        onclick="openEditModal(
                            '{{ item.id }}', 
                            '{{ item.client_id }}', 
                            '{{ item.project_title }}', 
                            '{{ item.total_amount }}', 
                            '{{ item.paid_amount }}', 
                            '{{ item.renewal_price }}', 
                            '{{ item.next_renewal_date or '' }}', 
                            '{{ item.last_payment_date or '' }}'
                        )"
                        class="w-8 h-8 rounded-lg flex items-center justify-center bg-blue-500/10 text-blue-400 hover:bg-blue-500 hover:text-white transition-all" title="Edit">
                        <i class="fa-solid fa-pen text-xs"></i>
                    </button>
                    <button onclick="openDeleteModal('{{ item.id }}')" class="w-8 h-8 rounded-lg flex items-center justify-center bg-danger/10 text-danger hover:bg-danger hover:text-white transition-all" title="Delete">
                        <i class="fa-solid fa-trash text-xs"></i>
                    </button>
                </div>
            </td>

          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <div class="p-4 border-t border-border flex items-center justify-between text-xs text-text-secondary">
        <span id="financials-length">Showing {{ financials|length }} records</span>
        <div class="flex gap-1">
            <button class="px-2 py-1 rounded hover:bg-bg disabled:opacity-50" disabled>Previous</button>
            <button class="px-2 py-1 rounded hover:bg-bg">Next</button>
        </div>
    </div>

    {% else %}
    <div class="flex flex-col items-center justify-center py-16 text-center">
        <div class="w-20 h-20 bg-bg rounded-full flex items-center justify-center mb-4 shadow-inner">
            <i class="fa-solid fa-file-invoice text-3xl text-text-secondary/50"></i>
        </div>
        <h3 class="text-lg font-medium text-text-primary mb-1">No financial records</h3>
        <p class="text-text-secondary text-sm max-w-xs mb-6">Start tracking your project payments and debts.</p>
        <button onclick="openAddModal()" class="bg-surface border border-border hover:border-accent text-accent px-6 py-2 rounded-lg text-sm font-medium hover:cursor-pointer transition-colors">
            <i class="fa-solid fa-plus mr-2"></i> New Record
        </button>
    </div>
    {% endif %}
  </div>
</div>

<div id="addModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-black/60 transition-opacity backdrop-blur-sm" onclick="closeAddModal()"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-xl bg-surface border border-border text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl">
                <div class="px-6 py-4 border-b border-border flex justify-between items-center bg-bg/30">
                    <h3 class="text-lg font-bold text-text-primary">New Financial Record</h3>
                    <button onclick="closeAddModal()" class="text-text-secondary hover:text-text-primary transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                
                <form id="addFinancialForm" onsubmit="handleAddSubmit(event)">
                    <div class="px-6 py-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-text-secondary mb-1">Client <span class="text-danger">*</span></label>
                            <select name="client_id" id="add_client_select" required class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent">
                                <option value="" disabled selected>Select a Client...</option>
                            </select>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-text-secondary mb-1">Project Title <span class="text-danger">*</span></label>
                            <input type="text" name="project_title" required class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent" placeholder="e.g. Cafe Website Dev">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Total Amount</label>
                            <input type="number" step="0.01" name="total_amount" class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent" placeholder="0.00">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Paid Amount</label>
                            <input type="number" step="0.01" name="paid_amount" class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent" placeholder="0.00">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Renewal Price (Yearly)</label>
                            <input type="number" step="0.01" name="renewal_price" class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent" placeholder="0.00">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Next Renewal Date</label>
                            <input type="date" name="next_renewal_date" class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Last Payment Date</label>
                            <input type="date" name="last_payment_date" class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent">
                        </div>

                    </div>
                    <div class="px-6 py-4 bg-bg/30 border-t border-border flex flex-row-reverse gap-3">
                        <button type="submit" class="w-full sm:w-auto inline-flex justify-center rounded-lg bg-accent px-4 py-2 text-sm font-bold text-bg shadow-sm hover:bg-emerald-600 sm:ml-3">Save</button>
                        <button type="button" onclick="closeAddModal()" class="mt-3 sm:mt-0 w-full sm:w-auto inline-flex justify-center rounded-lg bg-transparent border border-border px-4 py-2 text-sm font-medium text-text-secondary hover:bg-bg hover:text-text-primary">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="editModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-black/60 transition-opacity backdrop-blur-sm" onclick="closeEditModal()"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-xl bg-surface border border-border text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl">
                <div class="px-6 py-4 border-b border-border flex justify-between items-center bg-bg/30">
                    <h3 class="text-lg font-bold text-text-primary">Edit Financial Record</h3>
                    <button onclick="closeEditModal()" class="text-text-secondary hover:text-text-primary transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                
                <form id="editFinancialForm" onsubmit="handleEditSubmit(event)">
                    <input type="hidden" id="edit_financial_id" name="id">
                    <div class="px-6 py-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-text-secondary mb-1">Client <span class="text-danger">*</span></label>
                            <select name="client_id" id="edit_client_select" required class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent">
                            </select>
                        </div>

                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-text-secondary mb-1">Project Title <span class="text-danger">*</span></label>
                            <input type="text" id="edit_project_title" name="project_title" required class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Total Amount</label>
                            <input type="number" step="0.01" id="edit_total_amount" name="total_amount" class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Paid Amount</label>
                            <input type="number" step="0.01" id="edit_paid_amount" name="paid_amount" class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Renewal Price</label>
                            <input type="number" step="0.01" id="edit_renewal_price" name="renewal_price" class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Next Renewal Date</label>
                            <input type="date" id="edit_next_renewal_date" name="next_renewal_date" class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Last Payment Date</label>
                            <input type="date" id="edit_last_payment_date" name="last_payment_date" class="w-full bg-bg border border-border rounded-lg px-4 py-2.5 text-text-primary focus:outline-none focus:border-accent">
                        </div>

                    </div>
                    <div class="px-6 py-4 bg-bg/30 border-t border-border flex flex-row-reverse gap-3">
                        <button type="submit" class="w-full sm:w-auto inline-flex justify-center rounded-lg bg-accent px-4 py-2 text-sm font-bold text-bg shadow-sm hover:bg-emerald-600 sm:ml-3">Update</button>
                        <button type="button" onclick="closeEditModal()" class="mt-3 sm:mt-0 w-full sm:w-auto inline-flex justify-center rounded-lg bg-transparent border border-border px-4 py-2 text-sm font-medium text-text-secondary hover:bg-bg hover:text-text-primary">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="deleteModal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/60 transition-opacity backdrop-blur-sm" onclick="closeDeleteModal()"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-xl bg-surface border border-border text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-md">
                <div class="px-6 py-6 text-center">
                    <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-danger/10 mb-4">
                        <i class="fa-solid fa-triangle-exclamation text-danger text-xl"></i>
                    </div>
                    <h3 class="text-lg font-bold text-text-primary mb-2">Delete Record?</h3>
                    <p class="text-sm text-text-secondary">Are you sure you want to delete this financial record? This cannot be undone.</p>
                </div>
                <div class="px-6 py-4 bg-bg/30 border-t border-border flex flex-row-reverse gap-3">
                    <form id="deleteFinancialForm" onsubmit="handleDeleteSubmit(event)" class="w-full sm:w-auto">
                        <input type="hidden" id="delete_financial_id" name="id">
                        <button type="submit" class="w-full inline-flex justify-center rounded-lg bg-danger px-4 py-2 text-sm font-bold text-white hover:bg-red-600 sm:ml-3">Delete</button>
                    </form>
                    <button type="button" onclick="closeDeleteModal()" class="mt-3 sm:mt-0 w-full sm:w-auto inline-flex justify-center rounded-lg bg-transparent border border-border px-4 py-2 text-sm font-medium text-text-secondary hover:bg-bg hover:text-text-primary">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let clientMap = {}; 

    document.addEventListener('DOMContentLoaded', async () => {
        await loadClientsIntoSelects();
    });

    async function loadClientsIntoSelects() {
        try {
            const response = await fetch('/api/clients');
            if (response.ok) {
                const clients = await response.json();
                const clientList = clients.clients ? clients.clients : clients;
                
                const addSelect = document.getElementById('add_client_select');
                const editSelect = document.getElementById('edit_client_select');
                
                addSelect.innerHTML = '<option value="" disabled selected>Select a Client...</option>';
                editSelect.innerHTML = '<option value="" disabled>Select a Client...</option>';

                clientList.forEach(client => {
                    clientMap[client.id] = client.full_name;
                    const option = `<option value="${client.id}">${client.full_name}</option>`;
                    addSelect.innerHTML += option;
                    editSelect.innerHTML += option;
                });
            }
        } catch (error) {
            console.error(error);
            showToast("Failed to load clients", "error");
        }
    }

    function openAddModal() { document.getElementById("addModal").classList.remove("hidden"); }
    function closeAddModal() { document.getElementById("addModal").classList.add("hidden"); }
    
    function openEditModal(id, clientId, title, total, paid, renewal, nextRen, lastPay) {
        document.getElementById("edit_financial_id").value = id;
        document.getElementById("edit_client_select").value = clientId;
        document.getElementById("edit_project_title").value = title;
        document.getElementById("edit_total_amount").value = total;
        document.getElementById("edit_paid_amount").value = paid;
        document.getElementById("edit_renewal_price").value = renewal;
        document.getElementById("edit_next_renewal_date").value = formatDateForInput(nextRen);
        document.getElementById("edit_last_payment_date").value = formatDateForInput(lastPay);
        
        document.getElementById("editModal").classList.remove("hidden");
    }
    
    function closeEditModal() { document.getElementById("editModal").classList.add("hidden"); }
    function openDeleteModal(id) { 
        document.getElementById("delete_financial_id").value = id; 
        document.getElementById("deleteModal").classList.remove("hidden"); 
    }
    function closeDeleteModal() { document.getElementById("deleteModal").classList.add("hidden"); }

    function formatDateForInput(dateStr) {
        if (!dateStr || dateStr === 'None') return '';
        return dateStr.split(' ')[0];
    }

    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        let bgClass = type === 'success' ? 'toast-success' : type === 'error' ? 'toast-error' : 'toast-warning';
        let icon = type === 'success' ? "<i class='fa-solid fa-check-circle'></i>" : "<i class='fa-solid fa-triangle-exclamation'></i>";
        toast.className = `toast ${bgClass}`;
        toast.innerHTML = `${icon} <span>${message}</span>`;
        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add('show'));
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
    }

    function getRowInnerHtml(item) {
        const total = parseFloat(item.total_amount || 0);
        const paid = parseFloat(item.paid_amount || 0);
        const remaining = total - paid;
        const percent = total > 0 ? (paid / total * 100) : 0;
        
        const clientName = item.client ? item.client.full_name : (clientMap[item.client_id] || 'Unknown');

        let statusBadge = '';
        if (remaining <= 0) {
            statusBadge = `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md text-xs font-medium bg-success/10 text-success border border-success/20"><i class="fa-solid fa-check"></i> Paid</span>`;
        } else {
            statusBadge = `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md text-xs font-medium bg-danger/10 text-danger border border-danger/20 font-mono">${remaining.toFixed(2)}</span>`;
        }

        let renewalHtml = '<span class="text-text-secondary text-xs">-</span>';
        if (item.renewal_price > 0) {
            renewalHtml = `<span class="text-sm text-text-primary font-mono">${item.renewal_price} JOD</span>`;
            if (item.next_renewal_date) {
                renewalHtml += `<div class="text-xs text-text-secondary flex items-center gap-1"><i class="fa-regular fa-calendar"></i> ${item.next_renewal_date}</div>`;
            }
        }

        const lastPayHtml = item.last_payment_date ? 
            `<span class="text-xs text-text-secondary border border-border px-2 py-1 rounded bg-bg">${item.last_payment_date}</span>` : 
            `<span class="text-text-secondary text-xs">-</span>`;

        return `
            <td class="p-4 align-top">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-accent/10 text-accent flex items-center justify-center font-bold border border-accent/20 flex-shrink-0">
                        <i class="fa-solid fa-file-invoice-dollar"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-text-primary group-hover:text-accent transition-colors">${item.project_title}</h3>
                        <span class="text-xs text-text-secondary block flex items-center gap-1"><i class="fa-solid fa-user text-[10px]"></i> ${clientName}</span>
                    </div>
                </div>
            </td>
            <td class="p-4 align-top">
                <div class="flex flex-col gap-1 w-32">
                    <div class="flex justify-between text-xs text-text-primary mb-1">
                        <span>Paid: ${paid}</span>
                        <span class="text-text-secondary">/ ${total}</span>
                    </div>
                    <div class="w-full bg-bg rounded-full h-1.5 border border-border overflow-hidden">
                        <div class="bg-accent h-1.5 rounded-full" style="width: ${percent}%"></div>
                    </div>
                </div>
            </td>
            <td class="p-4 align-top">${statusBadge}</td>
            <td class="p-4 align-top"><div class="flex flex-col gap-1">${renewalHtml}</div></td>
            <td class="p-4 align-middle text-center">${lastPayHtml}</td>
            <td class="p-4 align-middle text-right">
                <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="openEditModal('${item.id}', '${item.client_id}', '${item.project_title}', '${item.total_amount}', '${item.paid_amount}', '${item.renewal_price}', '${item.next_renewal_date || ''}', '${item.last_payment_date || ''}')" 
                            class="w-8 h-8 rounded-lg flex items-center justify-center bg-blue-500/10 text-blue-400 hover:bg-blue-500 hover:text-white transition-all" title="Edit">
                        <i class="fa-solid fa-pen text-xs"></i>
                    </button>
                    <button onclick="openDeleteModal('${item.id}')" class="w-8 h-8 rounded-lg flex items-center justify-center bg-danger/10 text-danger hover:bg-danger hover:text-white transition-all" title="Delete">
                        <i class="fa-solid fa-trash text-xs"></i>
                    </button>
                </div>
            </td>
        `;
    }

    async function handleAddSubmit(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch('/api/financials', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const res = await response.json();
            
            if (response.ok) {
                closeAddModal();
                event.target.reset();
                showToast('Record added successfully!', 'success');
                
                if (res.financial) {
                    const tbody = document.querySelector('table tbody');
                    const tr = document.createElement('tr');
                    tr.id = `financial-row-${res.financial.id}`;
                    tr.className = "group hover:bg-white/5 transition-colors duration-200";
                    tr.innerHTML = getRowInnerHtml(res.financial);
                    tbody.prepend(tr);
                    
                    const countSpan = document.getElementById('financials-length');
                    if(countSpan) {
                        const count = parseInt(countSpan.textContent.match(/\d+/)[0]) + 1;
                        countSpan.textContent = `Showing ${count} records`;
                    }
                } else {
                    window.location.reload();
                }
            } else {
                showToast(res.error || 'Error adding record', 'error');
            }
        } catch (error) {
            console.error(error);
            showToast('Failed to connect to server', 'error');
        }
    }

    async function handleEditSubmit(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch('/api/financials', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const res = await response.json();

            if (response.ok) {
                closeEditModal();
                showToast('Record updated successfully!', 'success');
                
                const row = document.getElementById(`financial-row-${data.id}`);
                if (row) {
                    const updatedItem = res.financial || data; 
                    row.innerHTML = getRowInnerHtml(updatedItem);
                    
                    row.classList.add('bg-accent/10');
                    setTimeout(() => row.classList.remove('bg-accent/10'), 1000);
                } else {
                    window.location.reload();
                }
            } else {
                showToast(res.error || 'Error updating record', 'error');
            }
        } catch (error) {
            console.error(error);
            showToast('Failed to connect to server', 'error');
        }
    }

    async function handleDeleteSubmit(event) {
        event.preventDefault();
        const id = document.getElementById("delete_financial_id").value;
        try {
            const response = await fetch(`/api/financials?id=${id}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            });
            const res = await response.json();
            
            closeDeleteModal();
            if (response.ok) {
                showToast('Record deleted successfully!', 'success');
                const row = document.getElementById(`financial-row-${id}`);
                if(row) row.remove();
                
                const countSpan = document.getElementById('financials-length');
                if(countSpan) {
                    const count = Math.max(0, parseInt(countSpan.textContent.match(/\d+/)[0]) - 1);
                    countSpan.textContent = `Showing ${count} records`;
                }
            } else {
                showToast(res.error || 'Error deleting record', 'error');
            }
        } catch (error) {
            console.error(error);
            showToast('Failed to connect to server', 'error');
        }
    }
</script>
{% endblock %}